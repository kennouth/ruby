<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruby Focus</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Ruby Focus">
    <!-- ... (rest of the head content) ... -->
</head>
<body>
    <!-- ... (body content remains the same) ... -->

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
    <script type="module">
        // ... (previous imports and setup) ...

        function getUserLocation(username, focus) {
            if ("geolocation" in navigator) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                };

                navigator.permissions.query({name:'geolocation'}).then(function(result) {
                    if (result.state === 'granted') {
                        navigator.geolocation.getCurrentPosition(successCallback, errorCallback, options);
                    } else if (result.state === 'prompt') {
                        alert("This app needs your location to place your focus on the map. Please allow location access when prompted.");
                        navigator.geolocation.getCurrentPosition(successCallback, errorCallback, options);
                    } else if (result.state === 'denied') {
                        alert("Location access was denied. Using IP-based location instead.");
                        useIpBasedLocation(username, focus);
                    }
                });
            } else {
                console.log("Geolocation not available");
                alert("Geolocation is not supported by your browser. Using IP-based location instead.");
                useIpBasedLocation(username, focus);
            }

            function successCallback(position) {
                let lat = position.coords.latitude;
                let lon = position.coords.longitude;
                console.log("User location:", lat, lon);
                addEntry(username, focus, lat, lon);
            }

            function errorCallback(error) {
                console.error("Error getting location:", error);
                alert("Couldn't get your location. Using IP-based location instead.");
                useIpBasedLocation(username, focus);
            }
        }

        function useIpBasedLocation(username, focus) {
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    let lat = data.latitude;
                    let lon = data.longitude;
                    console.log("IP-based location:", lat, lon);
                    addEntry(username, focus, lat, lon);
                })
                .catch(error => {
                    console.error("Error getting IP-based location:", error);
                    useRandomLocation(username, focus);
                });
        }

        function useRandomLocation(username, focus) {
            let lat = Math.random() * 180 - 90;
            let lon = Math.random() * 360 - 180;
            addEntry(username, focus, lat, lon);
        }

        // ... (rest of the code remains the same) ...

    </script>
</body>
</html>
